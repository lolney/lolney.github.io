<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="generator" content="Hugo 0.37" /> 
<title>Readings - Luke Olney</title>
<meta property="og:title" content="Readings - Luke Olney">       

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>



<script type="text/javascript" src="https://lukeolney.me/js/readmore.js"></script> 


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116576963-1"></script>
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag() { dataLayer.push(arguments); }
	gtag('js', new Date());

	gtag('config', 'UA-116576963-1');
</script>


<link rel="stylesheet" href="https://lukeolney.me/css/main.css" media="all">
<link rel="stylesheet" href="https://lukeolney.me/css/fonts.css">
  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://lukeolney.me/" class="nav-logo">
    <img src="https://lukeolney.me/images/logo.png" 
         width="50" 
         height="50" 
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/projects/">Projects</a></li>
    
    <li><a href="/readings/">Readings</a></li>
    
    <li><a href="/tags/">Tags</a></li>
    
  </ul>
</nav>

      </header>


<main class="content">

    <article>
        <header>
            <h1 class="article-title">Readings</h1>
        </header>
        
        <p>Short commentaries on technical blogs or papers that I&rsquo;ve read:</p>

    </article>
    <ul>

        <div class="list">
            
            <h2 class="list-title">2019</h2>
             <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="http://houdini.glitch.me/">CSS Houdini</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 01 August 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/css-houdini/">01 August 2019</a>
            </time>
            <ul class="article-taxonomy">
     
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>Houdini is a series of browser API proposal for extending CSS. It would allow developers to make highly-performant CSS polyfills, or even to create new CSS layout models like CSS grid or flexbox.</p>

<p>Houdini provides three main modes of implementing properties: the layout, paint, and animation APIs.</p>

<h3 id="layout-https-drafts-css-houdini-org-css-layout-api"><a href="https://drafts.css-houdini.org/css-layout-api/">Layout</a></h3>

<p>The layout API is what you would use to recreate flexbox, or else some other kind of custom layout. The sample below shows how it&rsquo;s done &ndash; you define <code>mylayout</code> though the <code>registerLayout</code> function. You can define properties that serve as variable inputs to your layout, and write the code that determines how children in the layout are positioned.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">registerLayout(
  <span style="color:#ed9d13">&#34;example&#34;</span>,
  <span style="color:#6ab825;font-weight:bold">class</span> {
    <span style="color:#6ab825;font-weight:bold">static</span> inputProperties = [<span style="color:#ed9d13">&#34;--foo&#34;</span>];
    <span style="color:#6ab825;font-weight:bold">static</span> childrenInputProperties = [<span style="color:#ed9d13">&#34;--bar&#34;</span>];
    <span style="color:#6ab825;font-weight:bold">static</span> layoutOptions = {
      childDisplay: <span style="color:#ed9d13">&#34;normal&#34;</span>,
      sizing: <span style="color:#ed9d13">&#34;block-like&#34;</span>
    };

    <span style="color:#6ab825;font-weight:bold">async</span> intrinsicSizes(children, edges, styleMap) {
      <span style="color:#999;font-style:italic">// Intrinsic sizes code goes here.
</span><span style="color:#999;font-style:italic"></span>    }

    <span style="color:#6ab825;font-weight:bold">async</span> layout(children, edges, constraints, styleMap, breakToken) {
      <span style="color:#999;font-style:italic">// Layout code goes here.
</span><span style="color:#999;font-style:italic"></span>    }
  }
);
</code></pre></div>
<p>In flexbox, inputProperties include <code>align-items</code> and childrenInputProperties <code>align-self</code>. Your custom variables have the same power to affect how items and their children are laid out, depending on how you want to use them.</p>

<p>The API controls much of the lifecycle of layout itself. You get to define:</p>

<ul>
<li>The element&rsquo;s min and max size, given the children&rsquo;s sizes</li>
<li>The available space for its children, given the element&rsquo;s size</li>
<li>The positions of each child, given the children&rsquo;s sizes</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">registerLayout(
  <span style="color:#ed9d13">&#34;block-like&#34;</span>,
  <span style="color:#6ab825;font-weight:bold">class</span> {
    <span style="color:#6ab825;font-weight:bold">async</span> intrinsicSizes(children, edges, styleMap) {
      <span style="color:#6ab825;font-weight:bold">const</span> childrenSizes = <span style="color:#6ab825;font-weight:bold">await</span> <span style="color:#24909d">Promise</span>.all(
        children.map(child =&gt; {
          <span style="color:#6ab825;font-weight:bold">return</span> child.intrinsicSizes();
        })
      );

      <span style="color:#6ab825;font-weight:bold">const</span> maxContentSize =
        childrenSizes.reduce((max, childSizes) =&gt; {
          <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#24909d">Math</span>.max(max, childSizes.maxContentSize);
        }, <span style="color:#3677a9">0</span>) + edges.inline;

      <span style="color:#6ab825;font-weight:bold">const</span> minContentSize =
        childrenSizes.reduce((max, childSizes) =&gt; {
          <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#24909d">Math</span>.max(max, childSizes.minContentSize);
        }, <span style="color:#3677a9">0</span>) + edges.inline;

      <span style="color:#6ab825;font-weight:bold">return</span> { maxContentSize, minContentSize };
    }

    <span style="color:#6ab825;font-weight:bold">async</span> layout(children, edges, constraints, styleMap) {
      <span style="color:#999;font-style:italic">// Determine our (inner) available size.
</span><span style="color:#999;font-style:italic"></span>      <span style="color:#6ab825;font-weight:bold">const</span> availableInlineSize = constraints.fixedInlineSize - edges.inline;
      <span style="color:#6ab825;font-weight:bold">const</span> availableBlockSize = constraints.fixedBlockSize
        ? constraints.fixedBlockSize - edges.block
        : <span style="color:#6ab825;font-weight:bold">null</span>;

      <span style="color:#6ab825;font-weight:bold">const</span> childFragments = [];
      <span style="color:#6ab825;font-weight:bold">const</span> childConstraints = { availableInlineSize, availableBlockSize };

      <span style="color:#6ab825;font-weight:bold">const</span> childFragments = <span style="color:#6ab825;font-weight:bold">await</span> <span style="color:#24909d">Promise</span>.all(
        children.map(child =&gt; {
          <span style="color:#6ab825;font-weight:bold">return</span> child.layoutNextFragment(childConstraints);
        })
      );

      <span style="color:#6ab825;font-weight:bold">let</span> blockOffset = edges.blockStart;
      <span style="color:#6ab825;font-weight:bold">for</span> (<span style="color:#6ab825;font-weight:bold">let</span> fragment <span style="color:#6ab825;font-weight:bold">of</span> childFragments) {
        <span style="color:#999;font-style:italic">// Position the fragment in a block like manner, centering it in the
</span><span style="color:#999;font-style:italic"></span>        <span style="color:#999;font-style:italic">// inline direction.
</span><span style="color:#999;font-style:italic"></span>        fragment.blockOffset = blockOffset;
        fragment.inlineOffset = <span style="color:#24909d">Math</span>.max(
          edges.inlineStart,
          (availableInlineSize - fragment.inlineSize) <span style="color:#a61717;background-color:#e3d2d2">/ 2</span>
        );

        blockOffset += fragment.blockSize;
      }

      <span style="color:#6ab825;font-weight:bold">const</span> autoBlockSize = blockOffset + edges.blockEnd;

      <span style="color:#6ab825;font-weight:bold">return</span> {
        autoBlockSize,
        childFragments
      };
    }
  }
);
</code></pre></div>
<h3 id="paint-https-googlechromelabs-github-io-houdini-samples-paint-worklet-border-radius-reverse-border-radius-reverse-js"><a href="https://googlechromelabs.github.io/houdini-samples/paint-worklet/border-radius-reverse/border-radius-reverse.js">Paint</a></h3>

<p>The paint API gives an SVG- or canvas-like drawing API that you can control via CSS properties. The following draws a circle with the radius given by <code>border-radius-reverse</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#6ab825;font-weight:bold">class</span> BorderRadiusReversePainter {
  <span style="color:#6ab825;font-weight:bold">static</span> get inputProperties() {
    <span style="color:#6ab825;font-weight:bold">return</span> [<span style="color:#ed9d13">&#34;--border-radius-reverse&#34;</span>, <span style="color:#ed9d13">&#34;--border-radius-reverse-color&#34;</span>];
  }

  clearCircle(context, x, y, radius) {
    context.save();
    context.beginPath();
    context.arc(x, y, radius, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">2</span> * <span style="color:#24909d">Math</span>.PI, <span style="color:#6ab825;font-weight:bold">true</span>);
    context.clip();
    context.clearRect(x - radius, y - radius, radius * <span style="color:#3677a9">2</span>, radius * <span style="color:#3677a9">2</span>);
    context.restore();
  }

  paint(ctx, geom, props) {
    <span style="color:#6ab825;font-weight:bold">const</span> radiusValue = <span style="color:#24909d">Number</span>(props.get(<span style="color:#ed9d13">&#34;--border-radius-reverse&#34;</span>).toString());

    ctx.fillStyle = props.get(<span style="color:#ed9d13">&#34;--border-radius-reverse-color&#34;</span>).toString();
    ctx.fillRect(<span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, geom.width, geom.height);

    <span style="color:#6ab825;font-weight:bold">this</span>.clearCircle(ctx, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">0</span>, radiusValue); <span style="color:#999;font-style:italic">// Left top
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#6ab825;font-weight:bold">this</span>.clearCircle(ctx, geom.width, geom.height, radiusValue); <span style="color:#999;font-style:italic">// Right bottom
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#6ab825;font-weight:bold">this</span>.clearCircle(ctx, <span style="color:#3677a9">0</span>, geom.height, radiusValue); <span style="color:#999;font-style:italic">// Left bottom
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#6ab825;font-weight:bold">this</span>.clearCircle(ctx, geom.width, <span style="color:#3677a9">0</span>, radiusValue); <span style="color:#999;font-style:italic">// Right top
</span><span style="color:#999;font-style:italic"></span>  }
}

registerPaint(<span style="color:#ed9d13">&#34;border-radius-reverse&#34;</span>, BorderRadiusReversePainter);
</code></pre></div>
<h3 id="animation-https-github-com-w3c-css-houdini-drafts-tree-master-css-animationworklet"><a href="https://github.com/w3c/css-houdini-drafts/tree/master/css-animationworklet">Animation</a></h3>

<p>The WorkletAnimation API provides a way for CSS animation effects to hook into user input. It allows you to define keyframes and a way to a way to translate the current time into the progress of the animation, which runs in a worklet thread:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">registerAnimator(
  <span style="color:#ed9d13">&#34;my-awesome-animator&#34;</span>,
  <span style="color:#6ab825;font-weight:bold">class</span> Passthrough <span style="color:#6ab825;font-weight:bold">extends</span> StatelessAnimator {
    animate(currentTime, effect) {
      <span style="color:#999;font-style:italic">// The simplest custom animator that does exactly what regular animations do!
</span><span style="color:#999;font-style:italic"></span>      effect.localTime = currentTime;
    }
  }
);
</code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#999;font-style:italic">// Load your custom animator in the worklet
</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">await</span> CSS.animationWorklet.addModule(<span style="color:#ed9d13">&#34;animator.js&#34;</span>);

<span style="color:#6ab825;font-weight:bold">const</span> effect = <span style="color:#6ab825;font-weight:bold">new</span> KeyframeEffect(
  targetEl,
  { transform: [<span style="color:#ed9d13">&#34;translateX(0)&#34;</span>, <span style="color:#ed9d13">&#34;translateX(50vw)&#34;</span>] },
  { duration: <span style="color:#3677a9">1000</span> }
);
<span style="color:#6ab825;font-weight:bold">const</span> animation = <span style="color:#6ab825;font-weight:bold">new</span> WorkletAnimation(<span style="color:#ed9d13">&#34;my-awesome-animator&#34;</span>, effect);
animation.play();
</code></pre></div>
<p>As well as defining your own timelines (in <code>animate</code>), you can use provided animation timelines like <code>ScrollTimeline</code> to translate user scroll input into animation progress.</p>

<p>Here&rsquo;s a full example, with more available in the <a href="https://github.com/w3c/css-houdini-drafts/tree/master/css-animationworklet">explainer</a>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[
  <span style="color:#ed9d13">&#34;--avatar-size&#34;</span>,
  <span style="color:#ed9d13">&#34;--avatar-border&#34;</span>,
  <span style="color:#ed9d13">&#34;--header-height&#34;</span>,
  <span style="color:#ed9d13">&#34;--font-base&#34;</span>,
  <span style="color:#ed9d13">&#34;--bar-height&#34;</span>,
  <span style="color:#ed9d13">&#34;--spacer&#34;</span>
].forEach(name =&gt; {
  CSS.registerProperty({
    name,
    syntax: <span style="color:#ed9d13">&#34;&lt;length&gt;&#34;</span>,
    initialValue: <span style="color:#ed9d13">&#34;0px&#34;</span>,
    inherits: <span style="color:#6ab825;font-weight:bold">true</span>
  });
});

<span style="color:#6ab825;font-weight:bold">async</span> <span style="color:#6ab825;font-weight:bold">function</span> init() {
  <span style="color:#6ab825;font-weight:bold">await</span> animationWorklet.addModule(<span style="color:#ed9d13">&#34;twitter-header-animator.js&#34;</span>);
  <span style="color:#6ab825;font-weight:bold">const</span> scrollSource = <span style="color:#24909d">document</span>.body;
  <span style="color:#6ab825;font-weight:bold">const</span> bar = <span style="color:#24909d">document</span>.querySelector(<span style="color:#ed9d13">&#34;.bar&#34;</span>);
  <span style="color:#6ab825;font-weight:bold">const</span> avatar = <span style="color:#24909d">document</span>.querySelector(<span style="color:#ed9d13">&#34;.profile .avatar&#34;</span>);
  <span style="color:#6ab825;font-weight:bold">const</span> follow = <span style="color:#24909d">document</span>.querySelector(<span style="color:#ed9d13">&#34;.profile .follow&#34;</span>);
  <span style="color:#6ab825;font-weight:bold">const</span> name = <span style="color:#24909d">document</span>.querySelector(<span style="color:#ed9d13">&#34;.profile .name&#34;</span>);
  <span style="color:#6ab825;font-weight:bold">const</span> timeRange = <span style="color:#3677a9">1000</span>;
  <span style="color:#6ab825;font-weight:bold">const</span> scrollTimeline = <span style="color:#6ab825;font-weight:bold">new</span> ScrollTimeline({ scrollSource, timeRange });

  <span style="color:#6ab825;font-weight:bold">const</span> barEffect = <span style="color:#6ab825;font-weight:bold">new</span> KeyframeEffect(bar, [{ opacity: <span style="color:#3677a9">0</span> }, { opacity: <span style="color:#3677a9">1</span> }], {
    duration: <span style="color:#999;font-style:italic">/*timeWhenAvatarTouchesTop*/</span> <span style="color:#3677a9">0</span>,
    fill: <span style="color:#ed9d13">&#34;both&#34;</span>
  });
  <span style="color:#6ab825;font-weight:bold">new</span> WorkletAnimation(<span style="color:#ed9d13">&#34;twitter-header&#34;</span>, barEffect, scrollTimeline, []).play();
  <span style="color:#6ab825;font-weight:bold">const</span> avatarEffect = <span style="color:#6ab825;font-weight:bold">new</span> KeyframeEffect(
    avatar,
    [
      { transform: <span style="color:#ed9d13">`translateY(0) scale(1)`</span> },
      {
        transform: <span style="color:#ed9d13">`translateY(0px) scale(</span><span style="color:#ed9d13">${</span><span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*targetAvatarScale*/</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13">)`</span>,
        offset: <span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*timeWhenAvatarTouchesTop/timeRange*/</span>
      },
      {
        transform: <span style="color:#ed9d13">`translateY(</span><span style="color:#ed9d13">${</span><span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*maxAvatarOffset*/</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13">px) scale(</span><span style="color:#ed9d13">${</span>
          <span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*targetAvatarScale*/</span>
        <span style="color:#ed9d13">}</span><span style="color:#ed9d13">)`</span>
      }
    ],
    {
      duration: timeRange,
      fill: <span style="color:#ed9d13">&#34;both&#34;</span>
    }
  );
  <span style="color:#6ab825;font-weight:bold">new</span> WorkletAnimation(
    <span style="color:#ed9d13">&#34;twitter-header&#34;</span>,
    avatarEffect,
    scrollTimeline,
    []
  ).play();

  <span style="color:#6ab825;font-weight:bold">const</span> followEffect = <span style="color:#6ab825;font-weight:bold">new</span> KeyframeEffect(
    follow,
    [
      { transform: <span style="color:#ed9d13">`translateY(0)`</span> },
      {
        transform: <span style="color:#ed9d13">`translateY(0)`</span>,
        offset: <span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*timeWhenFollowTouchesTop/range*/</span>
      },
      { transform: <span style="color:#ed9d13">`translateY(</span><span style="color:#ed9d13">${</span><span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*maxAvatarOffset*/</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13">px)`</span> }
    ],
    {
      duration: timeRange,
      fill: <span style="color:#ed9d13">&#34;both&#34;</span>
    }
  );
  <span style="color:#6ab825;font-weight:bold">new</span> WorkletAnimation(
    <span style="color:#ed9d13">&#34;twitter-header&#34;</span>,
    followEffect,
    scrollTimeline,
    []
  ).play();

  <span style="color:#6ab825;font-weight:bold">const</span> nameEffect = <span style="color:#6ab825;font-weight:bold">new</span> KeyframeEffect(
    name,
    [
      { transform: <span style="color:#ed9d13">`translateY(0)`</span> },
      {
        transform: <span style="color:#ed9d13">`translateY(0)`</span>,
        offset: <span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*timeWhenFollowTouchesTop/timeRange*/</span>
      },
      {
        transform: <span style="color:#ed9d13">`translateY(0) translateX(</span><span style="color:#ed9d13">${</span>
          <span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*scrollSourceStyles.get(&#39;--bar-height&#39;).value*/</span>
        <span style="color:#ed9d13">}</span><span style="color:#ed9d13">px)`</span>,
        offset: <span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*timeWhenNameTouchesTop/timeRange*/</span>
      },
      {
        transform: <span style="color:#ed9d13">`translateY(</span><span style="color:#ed9d13">${</span><span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*maxNameOffset*/</span><span style="color:#ed9d13">}</span><span style="color:#ed9d13">px) translateX(</span><span style="color:#ed9d13">${</span>
          <span style="color:#3677a9">0</span> <span style="color:#999;font-style:italic">/*scrollSourceStyles.get(&#39;--bar-height&#39;).value*/</span>
        <span style="color:#ed9d13">}</span><span style="color:#ed9d13">px)`</span>
      }
    ],
    {
      duration: timeRange,
      fill: <span style="color:#ed9d13">&#34;both&#34;</span>
    }
  );
  <span style="color:#6ab825;font-weight:bold">new</span> WorkletAnimation(<span style="color:#ed9d13">&#34;twitter-header&#34;</span>, nameEffect, scrollTimeline, []).play();

  <span style="color:#6ab825;font-weight:bold">function</span> updateTimings() {
    <span style="color:#6ab825;font-weight:bold">const</span> scrollSourceStyles = <span style="color:#24909d">document</span>.body.computedStyleMap();
    <span style="color:#6ab825;font-weight:bold">const</span> viewportHeight = scrollSource.clientHeight;
    <span style="color:#6ab825;font-weight:bold">const</span> maxScroll = scrollSource.scrollHeight - viewportHeight;

    <span style="color:#6ab825;font-weight:bold">const</span> avatarDistanceFromTop =
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--header-height&#34;</span>).value <span style="color:#a61717;background-color:#e3d2d2">/ 2 -</span>
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--avatar-size&#34;</span>).value <span style="color:#a61717;background-color:#e3d2d2">/ 2 -</span>
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--avatar-border&#34;</span>).value;
    <span style="color:#6ab825;font-weight:bold">const</span> timeWhenAvatarTouchesTop =
      (avatarDistanceFromTop <span style="color:#a61717;background-color:#e3d2d2">/ maxScroll) * timeRange;</span>
    <span style="color:#6ab825;font-weight:bold">const</span> maxAvatarOffset = maxScroll - avatarDistanceFromTop;
    <span style="color:#6ab825;font-weight:bold">const</span> targetAvatarScale =
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--bar-height&#34;</span>).value <span style="color:#a61717;background-color:#e3d2d2">/</span>
      (scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--avatar-size&#34;</span>).value +
        scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--avatar-border&#34;</span>).value * <span style="color:#3677a9">2</span>);

    <span style="color:#6ab825;font-weight:bold">const</span> avatarEffectKeyFrames = avatarEffect.getKeyframes();
    avatarEffectKeyFrames[<span style="color:#3677a9">1</span>].transform = <span style="color:#ed9d13">`translateY(0px) scale(</span><span style="color:#ed9d13">${</span>targetAvatarScale<span style="color:#ed9d13">}</span><span style="color:#ed9d13">)`</span>;
    avatarEffectKeyFrames[<span style="color:#3677a9">1</span>].offset = timeWhenAvatarTouchesTop <span style="color:#a61717;background-color:#e3d2d2">/ timeRange;</span>
    avatarEffectKeyFrames[<span style="color:#3677a9">2</span>].transform = <span style="color:#ed9d13">`translateY(</span><span style="color:#ed9d13">${</span>maxAvatarOffset<span style="color:#ed9d13">}</span><span style="color:#ed9d13">px) scale(</span><span style="color:#ed9d13">${</span>targetAvatarScale<span style="color:#ed9d13">}</span><span style="color:#ed9d13">)`</span>;
    avatarEffect.setKeyframes(avatarEffectKeyFrames);

    barEffect.duration = timeWhenAvatarTouchesTop;

    <span style="color:#6ab825;font-weight:bold">const</span> followDistanceFromTop =
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--header-height&#34;</span>).value <span style="color:#a61717;background-color:#e3d2d2">/ 2 +</span>
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--spacer&#34;</span>).value <span style="color:#a61717;background-color:#e3d2d2">/ 2;</span>
    <span style="color:#6ab825;font-weight:bold">const</span> timeWhenFollowTouchesTop =
      (followDistanceFromTop <span style="color:#a61717;background-color:#e3d2d2">/ maxScroll) * timeRange;</span>
    <span style="color:#6ab825;font-weight:bold">const</span> maxFollowOffset = maxScroll - followDistanceFromTop;
    <span style="color:#6ab825;font-weight:bold">const</span> followEffectKeyFrames = followEffect.getKeyframes();
    followEffectKeyFrames[<span style="color:#3677a9">1</span>].offset = timeWhenFollowTouchesTop <span style="color:#a61717;background-color:#e3d2d2">/ timeRange;</span>
    followEffectKeyFrames[<span style="color:#3677a9">2</span>].transform = <span style="color:#ed9d13">`translateY(</span><span style="color:#ed9d13">${</span>maxFollowOffset<span style="color:#ed9d13">}</span><span style="color:#ed9d13">px)`</span>;
    followEffect.setKeyframes(followEffectKeyFrames);

    <span style="color:#6ab825;font-weight:bold">const</span> nameDistanceFromTop =
      name.offsetTop - scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--spacer&#34;</span>).value;
    <span style="color:#6ab825;font-weight:bold">const</span> timeWhenNameTouchesTop =
      (nameDistanceFromTop <span style="color:#a61717;background-color:#e3d2d2">/ maxScroll) * timeRange;</span>
    <span style="color:#6ab825;font-weight:bold">const</span> maxNameOffset = maxScroll - nameDistanceFromTop;
    <span style="color:#6ab825;font-weight:bold">const</span> nameEffectKeyFrames = nameEffect.getKeyframes();
    <span style="color:#6ab825;font-weight:bold">const</span> nameLeftOffset =
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--bar-height&#34;</span>).value +
      scrollSourceStyles.get(<span style="color:#ed9d13">&#34;--spacer&#34;</span>).value <span style="color:#a61717;background-color:#e3d2d2">/ 2;</span>
    nameEffectKeyFrames[<span style="color:#3677a9">1</span>].offset = timeWhenAvatarTouchesTop <span style="color:#a61717;background-color:#e3d2d2">/ timeRange;</span>
    nameEffectKeyFrames[<span style="color:#3677a9">2</span>].transform = <span style="color:#ed9d13">`translateY(0) translateX(</span><span style="color:#ed9d13">${</span>nameLeftOffset<span style="color:#ed9d13">}</span><span style="color:#ed9d13">px)`</span>;
    nameEffectKeyFrames[<span style="color:#3677a9">2</span>].offset = timeWhenNameTouchesTop <span style="color:#a61717;background-color:#e3d2d2">/ timeRange;</span>
    nameEffectKeyFrames[<span style="color:#3677a9">3</span>].transform = <span style="color:#ed9d13">`translateY(</span><span style="color:#ed9d13">${</span>maxNameOffset<span style="color:#ed9d13">}</span><span style="color:#ed9d13">px) translateX(</span><span style="color:#ed9d13">${</span>nameLeftOffset<span style="color:#ed9d13">}</span><span style="color:#ed9d13">px)`</span>;
    nameEffect.setKeyframes(nameEffectKeyFrames);
  }
  updateTimings();
  <span style="color:#24909d">window</span>.addEventListener(<span style="color:#ed9d13">&#34;resize&#34;</span>, _ =&gt; updateTimings());
}
init();
</code></pre></div>
<h3 id="other-components">Other Components</h3>

<h4 id="worklets">Worklets</h4>

<p><code>registerLayout</code> and <code>registerPaint</code> register worklets. Worklets are like webworkers, running in a separate browser process, but the browser&rsquo;s layout engine controls when they&rsquo;re called.</p>

<h4 id="css-object-model">CSS Object Model</h4>

<p>A separate proposal, the CSS object model, provides a mapping of CSS values to Javascript objects, like <code>CSS.number(0.5)</code> or <code>CSS.em(2)</code>. This is supposed to improve performance compared to implementing typing in pure JS, which interfaces with CSS via strings and must convert them back and forth.</p>

<p>You can use this to get or set properties directly on on an element via its <code>attributeStyleMap</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">myElement.attributeStyleMap.set(<span style="color:#ed9d13">&#34;opacity&#34;</span>, CSS.number(<span style="color:#3677a9">3</span>));
myElement.attributeStyleMap.set(<span style="color:#ed9d13">&#34;z-index&#34;</span>, CSS.number(<span style="color:#3677a9">15.4</span>));

console.log(myElement.attributeStyleMap.get(<span style="color:#ed9d13">&#34;opacity&#34;</span>).value); <span style="color:#999;font-style:italic">// 3
</span><span style="color:#999;font-style:italic"></span>console.log(myElement.attributeStyleMap.get(<span style="color:#ed9d13">&#34;z-index&#34;</span>).value); <span style="color:#999;font-style:italic">// 15.4
</span><span style="color:#999;font-style:italic"></span></code></pre></div>
<h4 id="css-registerproperty"><code>CSS.registerProperty</code></h4>

<p>New properties are defined via the custom properties API, which allow you more or less to mimic any already existing CSS property. For instance, you make them limited to a single DOM node rather than cascading down the tree:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">CSS.registerProperty({
  name: <span style="color:#ed9d13">&#34;--foo&#34;</span>, <span style="color:#999;font-style:italic">// String, name of the custom property
</span><span style="color:#999;font-style:italic"></span>  syntax: <span style="color:#ed9d13">&#34;&lt;color&gt;&#34;</span>, <span style="color:#999;font-style:italic">// String, how to parse this property. Defaults to *
</span><span style="color:#999;font-style:italic"></span>  inherits: <span style="color:#6ab825;font-weight:bold">false</span>, <span style="color:#999;font-style:italic">// Boolean, if true should inherit down the DOM tree
</span><span style="color:#999;font-style:italic"></span>  initialValue: <span style="color:#ed9d13">&#34;black&#34;</span> <span style="color:#999;font-style:italic">// String, initial value of this property
</span><span style="color:#999;font-style:italic"></span>});
</code></pre></div>
<p>Here&rsquo;s how that would look in a CSS rule:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">.<span style="color:#447fcf">my-layout-element</span> {
  <span style="color:#6ab825;font-weight:bold">display</span>: <span style="color:#447fcf">layout</span>(<span style="color:#ed9d13">&#34;mylayout&#34;</span>);
  foo: <span style="color:#6ab825;font-weight:bold">red</span>;
}</code></pre></div>
            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="https://github.com/vuejs/rfcs/blob/function-apis/active-rfcs/0000-function-api.md#multiple-logic-topics">Vue functions API RFC, compared with React hooks</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 23 June 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/vue-functions/">23 June 2019</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/react">React</a>
        <a href="/tags/vue">Vue</a>
        <a href="/tags/web">Web</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>The Vue core team recently released a proposal for a &ldquo;functions API,&rdquo; essentially implementing React hooks in Vue.</p>

<p>The functions API shares a lot of the advantages of hooks: Compared with class components, stateful logic is more easily extractable and composable. Compared to HOCs, there are no unnecessary components created and prop naming clashes are better avoided.</p>

<p>Here is a side-by-side for a simple program:</p>

<h3 id="counting">Counting:</h3>

<p>Vue:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#6ab825;font-weight:bold">template</span>&gt;
  &lt;<span style="color:#6ab825;font-weight:bold">span</span>&gt;{{ count }}&lt;/<span style="color:#6ab825;font-weight:bold">span</span>&gt;
&lt;/<span style="color:#6ab825;font-weight:bold">template</span>&gt;

&lt;<span style="color:#6ab825;font-weight:bold">script</span>&gt;
  <span style="color:#6ab825;font-weight:bold">import</span> { value } from <span style="color:#ed9d13">&#34;vue&#34;</span>;

  <span style="color:#6ab825;font-weight:bold">export</span> <span style="color:#6ab825;font-weight:bold">default</span> {
    setup() {
      <span style="color:#6ab825;font-weight:bold">const</span> count = value(<span style="color:#3677a9">0</span>);
      <span style="color:#6ab825;font-weight:bold">const</span> increment = () =&gt; {
        count.value++;
      };
      <span style="color:#6ab825;font-weight:bold">return</span> {
        count,
        increment
      };
    }
  };
&lt;/<span style="color:#6ab825;font-weight:bold">script</span>&gt;</code></pre></div>
<p>React:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#6ab825;font-weight:bold">import</span> React, { useState } from <span style="color:#ed9d13">&#34;react&#34;</span>;

<span style="color:#6ab825;font-weight:bold">function</span> App() {
  <span style="color:#6ab825;font-weight:bold">const</span> [count, setCount] = useState(<span style="color:#3677a9">0</span>);
  <span style="color:#6ab825;font-weight:bold">return</span> (
    &lt;<span style="color:#6ab825;font-weight:bold">div</span> <span style="color:#bbb">className</span>=<span style="color:#ed9d13">&#34;App&#34;</span>&gt;
      &lt;<span style="color:#6ab825;font-weight:bold">h1</span>&gt;{count}&lt;/<span style="color:#6ab825;font-weight:bold">h1</span>&gt;
      &lt;<span style="color:#6ab825;font-weight:bold">button</span> <span style="color:#bbb">onClick</span>=<span style="color:#ed9d13">{()</span> <span style="color:#a61717;background-color:#e3d2d2">=</span>&gt; setCount(count + <span style="color:#3677a9">1</span>)} <span style="color:#a61717;background-color:#e3d2d2">/&gt;</span>
    &lt;/<span style="color:#6ab825;font-weight:bold">div</span>&gt;
  );
}</code></pre></div>
<h3 id="comparison-with-hooks">Comparison with Hooks</h3>

<p>A few differences help to give it a bit more of the feel of vanilla Javascript, rather than a framework.</p>

<p>One is the separation of logic and the view via the <code>setup</code> function. Where hooks muddy things a bit by putting a value that only needs to be created once (<code>setCount</code>) inside a function that’s called on every render (App), Vue makes it clear that <code>increment</code> is only being defined once, in setup. Vue’s optional template system - you can define your view in JSX, too.</p>

<p>The <code>setup</code> function also eliminates the need for the <code>useCallback</code> hook. It&rsquo;s normally used to prevent unnecessary re-renders because of repeatedly recreating callback functions, but not needed if those are defined once.</p>

<p>Vue’s <code>value</code> function is just a wrapper, so you can just update the wrapped value directly:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#6ab825;font-weight:bold">const</span> count = value(<span style="color:#3677a9">0</span>);
count.value++;
</code></pre></div>
<p>While this seems to discourage updating values in a functional way, it is possible to create purely functional updaters through <code>computed</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#6ab825;font-weight:bold">const</span> count
<span style="color:#6ab825;font-weight:bold">const</span> writableComputed = computed(
  <span style="color:#999;font-style:italic">// read
</span><span style="color:#999;font-style:italic"></span>  () =&gt; count.value + <span style="color:#3677a9">1</span>,
)
</code></pre></div>
<p>There’s also a dependency injection API that’s similar to the React context API:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#6ab825;font-weight:bold">import</span> { provide, inject } from <span style="color:#ed9d13">&#34;vue&#34;</span>;

<span style="color:#6ab825;font-weight:bold">const</span> CountSymbol = Symbol();

<span style="color:#6ab825;font-weight:bold">const</span> Ancestor = {
  setup() {
    <span style="color:#999;font-style:italic">// providing a value can make it reactive
</span><span style="color:#999;font-style:italic"></span>    <span style="color:#6ab825;font-weight:bold">const</span> count = value(<span style="color:#3677a9">0</span>);
    provide({
      [CountSymbol]: count
    });
  }
};

<span style="color:#6ab825;font-weight:bold">const</span> Descendent = {
  setup() {
    <span style="color:#6ab825;font-weight:bold">const</span> count = inject(CountSymbol);
    <span style="color:#6ab825;font-weight:bold">return</span> {
      count
    };
  }
};
</code></pre></div>
<p>The <code>watch</code> function is similar to <code>useEffect</code>, but more explicitly reactive: it subscribes to changes in either props or state, rather than having to implement that check yourself.</p>

<h3 id="conclusions">Conclusions</h3>

<p>The <a href="https://news.ycombinator.com/item?id=20237568">reactions</a> to the proposal are mostly negative, mainly saying that it ruins Vue’s simplicity, or that it’s trying to beat React at its own game. It’s true, for instance, that this <a href="https://github.com/vuejs/rfcs/blob/function-apis/active-rfcs/0000-function-api.md#multiple-logic-topics">example, with the same component implemented with the function api and the current Vue api,</a> doesn’t show a clear winner: The component options in the original separates code along one dimension (methods, data, lifecycle), but the function api does along another (useFetch, useMouse). But it’s easy to see how the function API could have advantages in a larger codebase for composing stateful effects.</p>

<p>The question remains whether the functions API is worth using over React hooks. While functions appears like a pure improvement, it&rsquo;s perhaps not worth abandoning the superior support and ecosystem of React over relatively minor differences.</p>

            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="http://users.eecs.northwestern.edu/~scl025/files/ply-uist.pdf">Ply CSS Inspector</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 12 May 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/ply-css-inspector/">12 May 2019</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/css">CSS</a>
        <a href="/tags/papers">Papers</a>
        <a href="/tags/hci">HCI</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                <p>Working with CSS, it&rsquo;s easy to add CSS properties that are valid but have no visual effect. Some examples: invalid font families. <code>Color</code> on elements with no text. <code>align-items: center</code> on a flex container that&rsquo;s only as tall as its items.</p>

<p>Browser inspectors or CSS linters don&rsquo;t handle this well &ndash; Chrome dev tools won&rsquo;t tell you anything&rsquo;s wrong with those examples. They&rsquo;re still considered active since, as far as the browser is concerned, they&rsquo;re still being applied to the DOM.</p>

<p>Fixing this is what&rsquo;s really interesting about Ply, and why the concept is now being integrated into Firefox dev tools.</p>

<p>Static analysis of CSS, it turns out, can be difficult. Existing work highlighted by the paper, like browser dev tools or tools like <a href="http://www.cs.cmu.edu/~./webcrystal/">WebCrystal</a>, only manages to show which properties are currently rendered by the browser engine.</p>

<p>Ply detects relevant properties by applying visual relevance testing. It&rsquo;s very much like visual regression testing, in that you check for visual changes after introducing a change (in this case, adding a CSS property). CSS properties that don&rsquo;t cause a change are considered irrelevant.</p>

<p>This approach is also used to find dependencies. After the initial pruning round, each property A is disabled again (resulting in state 2), and the other n-1 properties B_i are disabled in turn (resulting in state 3). Any property B_i that does not cause a change between states 2 and 3 is dependent on A.</p>

<p>Eg, property A might be <code>display: flex</code> and B <code>align-items: center</code>. After A is removed, B will no longer do anything.</p>

<p>An approach like this that&rsquo;s entirely limited to runtime checking is limited, though &ndash; it&rsquo;s inefficient and doesn&rsquo;t lend well to error messages that explain why a particular property doesn&rsquo;t have any effect. Any real browser implementation would probably rely on a static dependency list, as the <a href="https://twitter.com/patrickbrosset/status/1118889616952766466/photo/1">Firefox dev tools version</a> seems to do. For a better automated approach, static analysis of the browser engine code (which determines the property interactions in the first place) ought to be able to generate a complete list of dependencies, not limited to what&rsquo;s just on the current page. Still, Ply manages to do a lot with a simple approach, and served as inspiration for beginning such work in the first place.</p>

            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="http://gameprogrammingpatterns.com/contents.html">Game Programming Patterns: Revisiting Design Patterns</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 04 May 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/game-programming-patterns/">04 May 2019</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/programming">Programming</a>
        <a href="/tags/design-patterns">Design patterns</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>This book has a game programming perspective, but it’s applicable to software of all sorts. It&rsquo;s kind of a modern take on the original GoF Design Patterns, showing the evolving meaning of the some and extending others.</p>

<p>Redux author Dan Abrahamov has recommended it, saying he &ldquo;wouldn&rsquo;t claim it&rsquo;s the best book ever&rdquo; but also that it&rsquo;s &ldquo;practical and fun&rdquo; and &ldquo;required reading for UI engineers.&rdquo; You certainly get explanations of some of the trends in programming models that motivated the creators of React, like favoring functional reactive components over imperative events, components over class hierachies, etc.</p>

<h2 id="the-patterns">The patterns</h2>

<p>I. <a href="#command">Command</a></p>

<p>II. <a href="#flyweight">Flyweight</a></p>

<p>III. <a href="#prototype">Prototype</a></p>

<p>IV. <a href="#singleton">Singleton</a></p>

<p>V. <a href="#state">State</a></p>

<h3 id="command">Command</h3>

<ul>
<li>Defintion: an object-oriented replacement for callbacks

<ul>
<li>That is, a method call wrapped in an object</li>
</ul></li>
<li>Supports attaching additional behavior to actions:

<ul>
<li>Permissions</li>
<li>Logging metadata</li>
</ul></li>
</ul>

<p>Actor controls example:
BUTTON_A -&gt; jumpCommand
BUTTON_B -&gt; shootCommand</p>

<pre><code>ShootCommand extends Command {
    execute(actor) {
        actor.jump()
    }
}
</code></pre>

<ul>
<li>Allows AI and player to be treated the same: just emit commands</li>
<li>Allows easily switching the actor that a player controls</li>
</ul>

<p>Undoing</p>

<ul>
<li>Tie an actor and previous state to each command</li>
<li>Keep a command history</li>
<li>Undoing a command means:</li>
<li>Pop the command off the command history</li>
<li>Set the state of the actor to the previous state</li>
</ul>

<p>Ties in with:</p>

<ul>
<li>Subclass sandbox: execute method may be better expressed as a composition of other methods</li>
<li>Chain of responsibility: actor may delegate to another object (e.g., shoot delegates to actor.gun)</li>
<li>Flyweight: if we have multiple controls creating a JumpCommand that’s largely the same, we might implement it as a Flyweight</li>
</ul>

<h3 id="flyweight">Flyweight</h3>

<ul>
<li>If there are elements duplicated among objects, limit the per-instance data to whatever’s unique and point each object to a shared copy of the rest.</li>
</ul>

<pre><code>Tree1 Tree2 Tree3
|————|———|
|
TreeModel
</code></pre>

<ul>
<li>Another example: a tile array points to terrain instances, which store info about each terrain type:</li>
</ul>

<pre><code>  [tile1, tile2, tile3, tile4]
  |———|    |    |—————————|
  |        |    |
  Grass River Hill
</code></pre>

<ul>
<li>Retains the advantages of an API that works with real objects</li>
</ul>

<h3 id="observer">Observer</h3>

<ul>
<li>This is an extremely ubiquitous pattern, baked into, eg, Javascript and C# with the &ldquo;Event&rdquo; class.</li>
<li>Decouples the logic of responding to events from creating the events</li>
</ul>

<pre><code>Subject (ie, event emitter)
-- Observer[] (ie, event handlers)
---- onNotify(event)
-- notify(event) (ie, emit)
</code></pre>

<ul>
<li>Potential concerns:

<ul>
<li>Speed: it&rsquo;s fast, with little overhead (just dynamic dispatch)</li>
<li>Blocking: if event handlers are synchronous, they should do not too much work or risk blocking the notifying thread</li>
<li>Observer list is dynamically allocated, but observers can also be treated as a linked list (with pointers part of the observer state)</li>
<li>Memory management: observers must take care to deregister themselves, including in GCed languages (where they otherwise won&rsquo;t be GCed)</li>
<li>Reasoning about behavior: hard to do statically, since the list of observers is only know at runtime (and these can come from anywhere in the code base)</li>
<li>Observers and subjects are loosely coupled, and reducing dependency is generally good. But if there is inherent dependency, best make it explicit.</li>
</ul></li>
</ul>

<p>Once common in UI programming, declarative reactive programming has replaced many use cases. A prescient quote:</p>

<blockquote>
<p>Like other declarative systems, data binding is probably a bit too slow and complex to fit inside the core of a game engine. But I would be surprised if I didn’t see it start making inroads into less critical areas of the game like UI.</p>
</blockquote>

<h3 id="prototype">Prototype</h3>

<ul>
<li>Example: a spawner creates monsters. The spawner holds a monster &ldquo;prototype,&rdquo; which can be cloned to create new monster instances.</li>
</ul>

<pre><code>Spawner {
    prototype: Monster;

    spawn() -&gt; Monster {
        return prototype.clone();
    }
}
</code></pre>

<ul>
<li><p>Concerns:</p>

<ul>
<li>We usually wouldn&rsquo;t maintain a massive class hierarchy for monsters, but make them instances of a monster type class.</li>
</ul></li>

<li><p>Alternatives:</p>

<ul>
<li>Type parameters:</li>
</ul></li>
</ul>

<pre><code>Spawner&lt;T&gt; {

    spawn() -&gt; T {
        return new T();
    }
}
</code></pre>

<ul>
<li>Another application: reducing redundancy in data modeling:</li>
</ul>

<pre><code>goblin = {
    height: 10,
    width: 10
}

greenGoblin = {
    prototype: goblin,
    color: &quot;green&quot;
}
</code></pre>

<h4 id="prototypes-in-javascript-and-other-languages">Prototypes in Javascript and other languages</h4>

<ul>
<li>In a pure prototype-based language &ndash; Self is the first example &ndash; objects are created by cloning other objects, at which point other fields can be added.</li>
<li>ES5 classes more closely resemble traditional classes, just defined a bit strangely (something that ES6 basically admits). A constructor is a function, not an object that can be cloned.</li>
</ul>

<h3 id="singleton">Singleton</h3>

<ul>
<li>Alternatives:

<ul>
<li>For preventing multiple instances:</li>
<li>Can make assert that a class is only created once, but not give global access</li>
<li>For &ldquo;manager&rdquo; or utility classes:</li>
<li>Use utility functions instead</li>
<li>For convenient access:</li>
<li>Attach to state that&rsquo;s already local (eg, attach logger to the game instance). Would, eg, prevent clashes between logs if multiple game instances are required in the future.</li>
</ul></li>
</ul>

<h3 id="state">State</h3>

<ul>
<li>Using dynamic dispatch:

<ul>
<li>Assume we have a set of actions, like <code>update</code> and <code>handleInput</code>, that depend on state. We implement that as classes that implement those actions as virtual methods:</li>
</ul></li>
</ul>

<pre><code>class DuckingState : public HeroineState {
    virtual void handleInput(Heroine&amp; heroine, Input input) {
        ...
    }

    virtual void update(Heroine&amp; heroine) {
        ...
    }
}
</code></pre>

<ul>
<li>State transitions can be delegated to the individual states. Here, handleInput returns the new state:</li>
</ul>

<pre><code>class GameState {
    handleInput(input: Input)
    {
        this.state = this.state.handleInput(input);
        state.enter()
    }
}
</code></pre>

<h4 id="concerns">Concerns:</h4>

<ul>
<li>A single state is often not enough. Eg, a character can be both running and jumping.

<ul>
<li>Mulitple state machines can solve this problem, but this doesn&rsquo;t model interaction well.</li>
<li>Hierachical state machines: can delegate common behavior to parent states. Has the normal problems of inheritance, though, like increased complexity of hidden behavior.</li>
</ul></li>
</ul>

            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="https://github.com/facebook/prepack">The Prepack Compiler</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 30 April 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/prepack/">30 April 2019</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/web">Web</a>
        <a href="/tags/javascript">Javascript</a>
        <a href="/tags/compilers">Compilers</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>Prepack is an experimental optimizing Javascript compiler. The existing major Javascript compilers, like Babel or Closure, focus on other things: code size reduction for the former, backwards compatibility for the latter. Prepack is all about optimization: function inlining, loop unrolling, and other transformations that shift some of the work to compile time.</p>

<h2 id="how-it-works">How it works</h2>

<p>It runs your code, then generates an optimized version that returns the same results. This makes it very good at optimizing, for example, a call to fib(10), which returns the 10th Fibonacci number.</p>

<p>It’s limited, by default, to code along the global path — ie, what’s run in the initialization phase — but it can also run specific code that you direct it to do so, as long as any state it depends on are defined by the time the initialization phase in complete.</p>

<h3 id="symbolic-execution-engine">Symbolic Execution Engine</h3>

<p>Certain results will depend on state, e.g., Date.now(), that can’t be determined at compile time. These can be substituted with abstract values, allowing optimizations to still be made over code that depends on them.</p>

<p>Here are some examples that I tried with the <a href="https://prepack.io/repl.html">Prepack repl</a> that could in principle be optimized, but aren&rsquo;t:</p>

<p>Eg 1:</p>

<pre><code>let now = Date.now();
now += 1;
now -= 1;
</code></pre>

<p>In this case, the compiler can deduce that the value of <code>now</code> (which could be any integer) is the same whether or not lines 2 and 3 execute, so it should optimize them away.</p>

<p>Eg 2:</p>

<pre><code>function f() {
    let now = Date.now()
    if(now * 2 == 12) {
        return 0;
    } else {
        return 1;
    }
}
</code></pre>

<p>Here, the result only depends on whether now is equal to 6. The abstract interpreter can replace the result with an abstract data type equivalent to (Date.now == 6 ? 0 : 1).</p>

<p>(This shows the result of a control flow merge that results in a conditional abstract value.)</p>

            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="https://overreacted.io">Notes on Overreacted</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 20 March 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/overreacted-notes/">20 March 2019</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/react">React</a>
        <a href="/tags/web">Web</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>Here are my notes on a few of my favorite posts on Overreacted, the blog of the React Core team&rsquo;s Dan Abramov.</p>

<h3 id="writing-resilient-components-https-overreacted-io-writing-resilient-components"><a href="https://overreacted.io/writing-resilient-components/">Writing Resilient Components</a></h3>

<ul>
<li>Things that don’t matter: too much deference on opinionated style guides/lint configs, cargo cult rules like “don’t call <code>setState</code> in <code>componentDidMount</code>. The former often puts too much emphasis on aesthetics and just creates conflict and stress without any improvement in maintainability.

<ul>
<li>It&rsquo;s really just important to have <em>some</em> set of rules, so that auto formatting is always consistent</li>
</ul></li>
</ul>

<h5 id="don-t-stop-the-data-flow">Don’t stop the data flow</h5>

<ul>
<li>For derived state, memoization is cleaner than <code>getDerivedStateFromProps</code>. <code>componentDidUpdate</code> is an option, but causes double renders.</li>
<li>Make sure that side effects are repeated on prop or state updates (eg, calls in <code>componentDidMount</code> may have to be repeated in <code>componentDidUpdate</code>)

<ul>
<li>Alternatively, the <code>useEffect</code> hook combines all lifecycle methods and makes prop, state dependencies explicit</li>
</ul></li>
<li>Be careful when comparing function props across updates: methods retain their identity across renders, but functions may not. The <code>useCallback</code> hook helps make this more explicit by memoizing closures so that their identity changes iff an element in the dependency array changes.</li>
</ul>

<h5 id="always-be-ready-to-render">Always be ready to render</h5>

<ul>
<li>Derived state can also have the &ldquo;blowing away&rdquo; problem: local state updates are overriden by props updates

<ul>
<li>Fix this by making components fully controlled, limiting state updates to a container component</li>
</ul></li>
</ul>

<h5 id="no-component-is-a-singleton">No component is a singleton</h5>

<ul>
<li>Any component, even something like a nav bar, might need to be rendered twice</li>
<li>Avoid global state for that reason</li>
</ul>

<h5 id="keep-the-local-state-isolated">Keep the Local State Isolated</h5>

<ul>
<li>What state should remain local vs. in a central (eg, Redux) store?</li>
<li>Try asking this question: if a component is rendered twice, what state should be updated in the other component when updated in one?</li>
<li>Local state should generally be limited to presentational state (eg, are these comments expanded?) or ephemeral state (eg, text in a comment field that hasn&rsquo;t been submitted)</li>
</ul>

<h3 id="why-do-we-write-super-props">Why do we write super(props)?</h3>

<ul>
<li>ES6 classes require super() to be called in the first line of the constructor (if at all), so that super class fields are initialized if you want to call super class methods</li>
<li>React requires super(props) mainly so that this.props is accessible in the constructor</li>
<li>But it’s not strictly necessary, since React initializes this.props after instantiating your opponent anyway</li>
</ul>

<h3 id="why-do-react-elements-have-typeof-property">Why do React elements have typeof property?</h3>

<ul>
<li>React escapes strings to prevent XSS attacks</li>
<li>Of course, it’s still vulnerable to attacks under certain conditions - eg, this renders arbitrary html:
<code>&lt;div dangerouslySetInnerHtml: {_html: “&lt;script&gt;stealPassword() &lt;/script&gt;”}&gt;</code></li>

<li><p>Could happen if you spread user input on a div</p></li>

<li><p>Could also happen if your server serves JSON where you expect text, and you get his:</p></li>
</ul>

<pre><code>let expectedTextButGotJSON = {
  type: 'div',
  props: {
    dangerouslySetInnerHTML: {
      __html: '/* put your exploit here */'
    },
  },
  // ...
};
let message = { text: expectedTextButGotJSON };

// Dangerous in React 0.13
&lt;p&gt;
  {message.text}
&lt;/p&gt;
See: http://danlec.com/blog/xss-via-a-spoofed-react-element
</code></pre>

<p>React protects against this by adding the typeof: symbol(‘react.elemt’) to React elements, which can’t be replicated in JSON. So, it’s a very specific fix - but it does enable the typeof function on React elements</p>

<h3 id="why-do-hooks-rely-on-call-order">Why do hooks rely on call order?</h3>

<p>useState can be used multiple times to create multiple state variables:</p>

<pre><code>const [a, setA] = useState(1);
const [b, setB] = useState(2);

const [b, setB] = useState(2);
useState(a) {
let current = a;

let setA = (a) =&gt; {
current = a;
};

return current;
}
</code></pre>

<p>This (supporting multiple useState calls) is mostly useful so that we can extract stateful logic into custom hooks that use useState:</p>

<p>This useWindowWidth hook outputs the window width as it changes with lifecycle updates (though apparently the same as just using window.innerWidth?):</p>

<pre><code>function useWindowWidth() {
// Declare some state and effects in a custom Hook
const [width, setWidth] = useState(window.innerWidth);
useEffect(() =&gt; {
// ...
});
return width;
}
</code></pre>

<p>Dan presents a number of solutions that involve passing an identifying key, and points out how each in turn fails to meet these requirements, or requires a lot of additional setup.</p>

            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="https://hacks.mozilla.org/2019/03/fast-bump-allocated-virtual-doms-with-rust-and-wasm/">Dodrio: Virtual DOMs in Rust</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 14 March 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/rust-virtual-doms/">14 March 2019</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/rust">Rust</a>
        <a href="/tags/browser-tech">Browser tech</a>
        <a href="/tags/javascript">Javascript</a>
        <a href="/tags/react">React</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>Javascript ecosystem tools like ESLint, Babel, NPM, or Webpack have traditionally been written in Javascript and run on the Node runtime. But there&rsquo;s no requirement that tools that process our JS code be written in JS themselves, and given that these tools are often computationally demanding, there have been <a href="https://www.notionjs.com/">attempts</a> to create more performant versions in languages like Rust.</p>

<p>The project described here takes that a step further, moving a process normally handled by front end JS libraries to high-performance code via WebAssembly.</p>

<p>The virtual DOM is at the core of how React, Ember, Angular, and Vue &ndash; name any recent front end view framework &ndash; do updates: a virtual representation of the DOM, mirroring the component tree, that can be diffed on updates to avoid making unnecessary updates to the actual DOM.</p>

<p>Dodrio implements the virtual DOM in Rust and does high-throughput transfers to JS to make the actual DOM updates. This raises the question, perhaps, if those updates could in the future be done directly in Wasm via the browser API, but the result is still faster than many of the libraries they benchmarked against.</p>

<h2 id="the-dodrio-api">The Dodrio API</h2>

<p>The API gives ways to manipulate virtual DOM nodes (including state, like counters) and render them. It also includes a Wasm interface for using Javacsript components in Rust:</p>

<pre><code>#[wasm_bindgen]
extern &quot;C&quot; {
    // Import the JS `Greeting` class.
    #[wasm_bindgen(extends = Object)]
    type Greeting;

    // And the `Greeting` class's constructor.
    #[wasm_bindgen(constructor)]
    fn new(who: &amp;str) -&gt; Greeting;
}

// Construct a JS rendering component from a `Greeting` instance.
let js = JsRender::new(Greeting::new(&quot;World&quot;));

</code></pre>

<h2 id="bump-allocation">Bump allocation</h2>

<p>Bump allocators treat allocation like adding to a stack: add new objects to the end, and you can&rsquo;t deallocate existing objects (except all of them at once).</p>

<p>Dodrio bump allocates its virtual DOM trees and the DOM mutations required after each render, batching the changes that will be made to the physical DOM.</p>

<p>Diagram provided by the blog post. Two trees - the two most recent renders - must be kept in memory at a given time:</p>

<pre><code>        ------------------- Time -------------------&gt;
Tree 0: [ render | ------ | diff ]
Tree 1:          [ render | diff | ------ | diff ]
Tree 2:                          [ render | diff | ------ | diff ]
Tree 3:                                          [ render | diff | ------ | diff ]
...

</code></pre>

<p>This is a simple garbage collector that avoid any of the overhead of a general tracing/generational GC.</p>

<h2 id="diffing-and-updating-the-dom">Diffing and updating the DOM</h2>

<p>The diffing process is done by walking the two trees in unison and noting whenever children, attributes, or listeners vary between the two. These changes are translated to instructions in a stack machine, which is read and interpreted in Javascript.</p>

            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="https://code.fb.com/core-data/apache-spark-scale-a-60-tb-production-use-case/">Spark at scale at Facebook</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 16 February 2019 ">
                <a title="Permalink" href="https://lukeolney.me/readings/spark-facebook/">16 February 2019</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/spark">Spark</a>
        <a href="/tags/distributed-systems">Distributed Systems</a>
        <a href="/tags/case-studies">Case Studies</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                <p>This blog post details Facebook&rsquo;s migration from Hive to Spark for a particular distributed data processing workload.</p>

<p>Spark is a distributed compute engine, allowing you to write SQL or imperative code that runs in a distributed environment with relatively few accommodations.</p>

<p>Example pipeline (Hive):</p>

<pre><code>Filter -&gt;
Group -&gt;
Reduce
</code></pre>

<p>In this writeup, the core task was to aggregate feature values for each entity_id, target_id pair and shard by entity id:</p>

<pre><code>entity_id, target_id, feature_id, feature_value

-&gt;

// Aggregation could be something like this - not explicit in writeup
entity_id, target_id: &lt;average, sum, ..&gt; feature_value for feature_id
</code></pre>

<p>In Hive, each step outputs a temporary table (stored in the HDFS) that serves as the input to the next step. Because this involved serializing and writing files to HDFS repeatedly along the way, this had a pretty severe performance cost in time and CPU hours.</p>

<p>In the Spark implementation described here, each step is instead combined into a single MapReduce job.</p>

<p>They also note some contributions to Spark to improve its reliability, where the great size of their workload revealed some cracks - especially where hardcoded limits proved to be too restrictive.</p>

<p>E.g., <a href="https://github.com/apache/spark/pull/12285/files">this pull request</a> solves a problem when a reducer&rsquo;s memory is fully allocated. Memory is taken up both by the pointer array (which is the array that&rsquo;s sorted) and the records pointed to by it. Initially, the code would reset the pointer array first (allocating new memory) then free the records, which could cause OoM errors unnecessarily.</p>

            </div>
        </div>
    </section>
</article>  
            <h2 class="list-title">2018</h2>
             <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="https://daniel.haxx.se/http3-explained/">HTTP/3 Explained</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 30 December 2018 ">
                <a title="Permalink" href="https://lukeolney.me/readings/http3/">30 December 2018</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/networking">Networking</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>HTTP/3 is the evolution of the HTTP standard with UDP. It’s based on a new transport-layer protocol called QUIC, which allows better parallelism of the features of HTTP/2.</p>

<p>HTTP/2 introduced multiplexing, which lets the browser send multiple requests without first waiting for the response. This appears parallel at the HTTP level, but it still relies on a single TCP connection. That means that any lost packet will hold up the chain of requests until that packet can be re-transmitted.</p>

<p>HTTP/3&rsquo;s solution continues to use a single connection, but allows transmission from other logical streams while waiting for a lost packet to be retransmitted. That requires implementing a new protocol that retains TCP’s features but allows more control over transmission of packets.</p>

<h2 id="streams">Streams</h2>

<p>QUIC brings HTTP streams to the transport layer. They are independently flow-controlled and independently head-blocked, with prioritization still done at the HTTP layer.</p>

<h2 id="ossification">Ossification</h2>

<p>Changing standards like TCP comes with costs: The Internet relies on a lot of intermediaries to survive, but many are not frequently updated — they will often drop packets on seeing TCP options that they don’t recognize. QUIC gets around this by operating purely with secure connections, preventing intermediaries from inspecting traffic.</p>

<p>This has been a problem with TCP Fast Open, the standard that allows sending data on the first handshake transmission. QUIC offers its own fast open handshake to address that.</p>

<p>Regardless, there are still barriers to using UDP as a transport - many routers block UDP traffic on the standard HTTP ports, for example. This means that HTTP/1 or /2 will still have to exist as a fallback and that connections to unknown hosts will have to be initiated that way.</p>

<h2 id="adoption">Adoption</h2>

<p>It’s already in use across much of the Internet - 7% of all Internet traffic in 2017. While the original Google-introduced protocol was just for HTTP, the IETF version includes a layer for non-HTTP protocols. The implementation for that is still in progress.</p>

<p>Adoption requires coordinating support among those who determine the path of the web, including browser vendors, Apache and nGinx, and TSL implementors.</p>

            </div>
        </div>
    </section>
</article>  <article class="preview">
    <header>
        <h1 class="post-title">
            <a href="https://docs.aws.amazon.com/aws-technical-content/latest/microservices-on-aws/microservices-on-aws.pdf?icmpid=link_from_whitepapers_page">Service Discovery</a>
        </h1>
        <div class="post-meta">
            <time datetime=" 02 December 2018 ">
                <a title="Permalink" href="https://lukeolney.me/readings/service-discovery/">02 December 2018</a>
            </time>
            <ul class="article-taxonomy">
     
    <li>
        <i class="fa fa-tags"></i>
        <a href="/tags/aws">AWS</a>
        <a href="/tags/microservices">microservices</a>
    </li>
    
</ul>
        </div>
    </header>
    <section class="post-excerpt">
        <div class="center">
            <i class="fa fa-spinner fa-spin"></i>
        </div>
        <div class="article-content">
            <div class="readmore" hidden=true>
                

<p>Service discovery deals with the problem of mapping services to IPs: If a load balancer wants to send a request to an API server, how does it figure out which ip address to sent it to? This AWS whitepaper gives a high level overview and trade-offs to a couple of approaches:</p>

<h2 id="domains-names-and-load-balancers">Domains Names and Load Balancers</h2>

<p>Alias service domain names (using CNAME records) to the load balancer, which routes to the correct service based on path or host name. This is vulnerable to DNS caching, but you can mitigate that with a short TTL.</p>

<h2 id="dns">DNS</h2>

<p>You can also use DNS to route requests directly to the service. Route 53 allows you to restrict access to services in your own virtual private cloud.</p>

<h2 id="configuration-management">Configuration management</h2>

<p>Map service names to IP addresses in your configuration, which you can set on server start. In particular, you can have new service register with a central configuration manager like AWS OpsWorks.</p>

<p>This is also the basis for frameworks like <a href="https://github.com/Netflix/eureka">Netflix Eurkea</a> or <a href="https://stripe.com/blog/service-discovery-at-stripe">Consul</a>.</p>

            </div>
        </div>
    </section>
</article>  
        </div>

        


<ul class="page-links">
  <li 
    class="page-links-disabled">
    <a href="" aria-label="Previous"><span aria-hidden="true">&lt;&#160;</span></a>
  </li>
  
  
  
  
  
   
    
    
  
  
    <li
      class="page-links-active"><a href="/readings/">1</a>
    </li>
    
  
  
  
  
   
    
    
  
  
    <li
      ><a href="/readings/page/2/">2</a>
    </li>
    
  
  
  
  
   
    
    
  
  
    <li
      ><a href="/readings/page/3/">3</a>
    </li>
    
  
  
  
  
   
    
    
  
  
    <li
      ><a href="/readings/page/4/">4</a>
    </li>
    
  
  <li
    >
    <a href="/readings/page/2/" aria-label="Next"><span aria-hidden="true">&#160;&gt;</span></a>
  </li>
</ul>



</main>

<footer class="footer">
  <ul class="footer-links">
    <li>
      <a href="https://github.com/lolney">
        <i class="fa fa-github"></i> Github</a>
    </li>
  </ul>
</footer>

</div>

</body>

</html>